#!/usr/bin/env bash
set -euo pipefail

python_files=()
while IFS= read -r file; do
  case "$file" in
    *.py) python_files+=("$file") ;;
  esac
done < <(git diff --cached --name-only --diff-filter=ACM)

if [ "${#python_files[@]}" -eq 0 ]; then
  exit 0
fi

if ! command -v pre-commit >/dev/null 2>&1; then
  echo "pre-commit is not installed; install it (e.g. 'uv tool install pre-commit')." >&2
  exit 1
fi

echo "Running ruff format on staged files..."
pre-commit run ruff-format --files "${python_files[@]}"
git add "${python_files[@]}"

echo "Running ruff check on staged files..."
pre-commit run ruff --files "${python_files[@]}"

if command -v uv >/dev/null 2>&1; then
  ty_cmd=(uv run ty)
elif command -v ty >/dev/null 2>&1; then
  ty_cmd=(ty)
else
  echo "ty is not installed; install it or run 'uv sync'." >&2
  exit 1
fi

echo "Running ty check on repository..."
"${ty_cmd[@]}" check .
