#!/usr/bin/env bash
set -euo pipefail

python_files=()
while IFS= read -r file; do
  case "$file" in
    *.py) python_files+=("$file") ;;
  esac
done < <(git diff --cached --name-only --diff-filter=ACM)

if [ "${#python_files[@]}" -eq 0 ]; then
  exit 0
fi

if command -v uv >/dev/null 2>&1; then
  ruff_cmd=(uv run ruff)
elif command -v ruff >/dev/null 2>&1; then
  ruff_cmd=(ruff)
else
  echo "ruff is not installed; install it or run 'uv sync'." >&2
  exit 1
fi

echo "Running ruff format on staged files..."
"${ruff_cmd[@]}" format "${python_files[@]}"
git add "${python_files[@]}"

echo "Running ruff check on staged files..."
"${ruff_cmd[@]}" check "${python_files[@]}"
